<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>基金产品方案 Word 自动生成</title>

  <style>
    /* =========================
       ✅ 主题：你后续要换配色/字体，改这里即可
       ========================= */
    :root {
      --bg: #f6f8fc;
      --card: rgba(255, 255, 255, .92);
      --card-strong: #fff;
      --text: #0f172a;
      --muted: #64748b;
      --line: rgba(148, 163, 184, .35);

      --primary: #2563eb;
      --primary-2: #1d4ed8;
      --ok: #16a34a;
      --warn: #f59e0b;
      --danger: #ef4444;

      --shadow: 0 18px 60px rgba(15, 23, 42, .12);
      --shadow-soft: 0 10px 30px rgba(15, 23, 42, .07);

      --radius: 18px;
      --radius-sm: 12px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      /* ✅ 底部固定条高度（JS会动态更新） */
      --footer-h: 88px;
    }

    :root[data-theme="dark"] {
      --bg: #0b1220;
      --card: rgba(17, 24, 39, .82);
      --card-strong: rgba(17, 24, 39, .96);
      --text: #e5e7eb;
      --muted: rgba(203, 213, 225, .78);
      --line: rgba(148, 163, 184, .22);

      --primary: #60a5fa;
      --primary-2: #93c5fd;
      --ok: #34d399;
      --warn: #fbbf24;
      --danger: #fb7185;

      --shadow: 0 18px 70px rgba(0, 0, 0, .38);
      --shadow-soft: 0 10px 30px rgba(0, 0, 0, .25);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    /* ✅ 防止横向溢出导致“文字看起来被遮挡/截断” */
    body {
      overflow-x: hidden;
    }

    /* ✅ scrollIntoView / 锚点滚动时，给底部固定条预留空间，避免定位后被盖住 */
    html {
      scroll-padding-bottom: calc(var(--footer-h) + 22px);
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 10% -15%, rgba(37, 99, 235, .18) 0%, transparent 55%),
        radial-gradient(900px 700px at 110% -10%, rgba(168, 85, 247, .16) 0%, transparent 55%),
        radial-gradient(900px 700px at 50% 110%, rgba(16, 185, 129, .12) 0%, transparent 55%),
        var(--bg);
    }

    a {
      color: var(--primary);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    /* ✅ 让底部固定条永远不盖住内容：给 container 动态 padding-bottom */
    .container {
      max-width: 1260px;
      margin: 22px auto 24px;
      padding: 0 16px;
      padding-bottom: calc(var(--footer-h) + 26px + env(safe-area-inset-bottom));
    }

    /* 顶部栏 */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 14px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(10px);

      /* ✅ 窄屏不挤压遮挡：允许换行 */
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;

      /* ✅ 允许 shrink，避免挤出屏幕 */
      min-width: 0;
      flex: 1 1 320px;
    }

    .logo {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(37, 99, 235, .92), rgba(168, 85, 247, .86));
      box-shadow: 0 12px 30px rgba(37, 99, 235, .25);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 900;
      letter-spacing: .4px;
      user-select: none;
      flex: 0 0 auto;
    }

    .brand-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .brand-title b {
      font-size: 15px;
      letter-spacing: .2px;
      line-height: 1.2;
    }

    .brand-title span {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      overflow-wrap: anywhere;
      /* ✅ 防长词溢出 */
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;

      /* ✅ 防止被 brand 挤出屏幕 */
      min-width: 0;
      flex: 0 1 auto;
    }

    /* 通用按钮/输入 */
    .btn {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .7);
      color: var(--text);
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    :root[data-theme="dark"] .btn {
      background: rgba(17, 24, 39, .65);
    }

    .btn:hover {
      background: rgba(15, 23, 42, .05);
      box-shadow: 0 10px 24px rgba(15, 23, 42, .06);
    }

    :root[data-theme="dark"] .btn:hover {
      background: rgba(255, 255, 255, .06);
      box-shadow: 0 10px 24px rgba(0, 0, 0, .25);
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    .btn.primary {
      background: var(--primary);
      color: #fff;
      border-color: rgba(37, 99, 235, .35);
    }

    .btn.primary:hover {
      background: var(--primary-2);
    }

    .btn.danger {
      background: rgba(239, 68, 68, .12);
      border-color: rgba(239, 68, 68, .25);
      color: var(--danger);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .55);
      color: var(--muted);
      font-size: 12px;
      max-width: 100%;
      overflow-wrap: anywhere;
    }

    :root[data-theme="dark"] .chip {
      background: rgba(17, 24, 39, .55);
    }

    .chip code {
      font-family: var(--mono);
      font-size: 11px;
    }

    /* 步骤条 */
    .stepper {
      margin-top: 14px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: stretch;
    }

    .step {
      flex: 1;
      min-width: 220px;
      border: 1px solid var(--line);
      border-radius: 16px;
      background: var(--card);
      box-shadow: var(--shadow-soft);
      padding: 11px 12px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .step .num {
      width: 30px;
      height: 30px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      color: #fff;
      background: rgba(100, 116, 139, .45);
      user-select: none;
      flex: 0 0 auto;
    }

    .step.active .num {
      background: linear-gradient(135deg, rgba(37, 99, 235, .92), rgba(168, 85, 247, .86));
    }

    .step .meta {
      min-width: 0;
    }

    .step .meta b {
      display: block;
      font-size: 13px;
      letter-spacing: .2px;
      margin-bottom: 2px;
    }

    .step .meta span {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      overflow-wrap: anywhere;
    }

    /* 主布局 */
    .grid {
      margin-top: 16px;
      display: grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 16px;
      align-items: start;
    }

    @media (max-width: 980px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .step {
        min-width: unset;
      }
    }

    .card {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      overflow: hidden;
      backdrop-filter: blur(10px);

      /* ✅ 让卡片在滚动定位时不被底部条盖住 */
      scroll-margin-bottom: calc(var(--footer-h) + 18px);
    }

    .card-hd {
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      background: linear-gradient(180deg, rgba(37, 99, 235, .10), transparent);
    }

    .card-hd>div {
      min-width: 0;
    }

    .card-hd h2 {
      margin: 0;
      font-size: 14px;
      letter-spacing: .2px;
      line-height: 1.25;
    }

    .card-hd .sub {
      color: var(--muted);
      font-size: 12px;
      margin-top: 4px;
      line-height: 1.35;
      overflow-wrap: anywhere;
    }

    .card-bd {
      padding: 14px 16px 16px;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 680px) {
      .row {
        grid-template-columns: 1fr;
      }
    }

    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 6px;
    }

    input[type="text"],
    select,
    textarea {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      background: var(--card-strong);
      color: var(--text);
      transition: box-shadow .15s ease, border-color .15s ease, transform .06s ease;
    }

    textarea {
      min-height: 130px;
      resize: vertical;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: rgba(37, 99, 235, .55);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, .14);
    }

    /* ✅ placeholder 颜色更柔和，不影响可读性 */
    input::placeholder,
    textarea::placeholder {
      color: rgba(100, 116, 139, .75);
    }

    :root[data-theme="dark"] input::placeholder,
    :root[data-theme="dark"] textarea::placeholder {
      color: rgba(203, 213, 225, .55);
    }

    .seg {
      display: flex;
      border: 1px solid var(--line);
      border-radius: 999px;
      overflow: hidden;
      background: var(--card-strong);
    }

    .seg button {
      border: none;
      background: transparent;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
      transition: background .15s ease, color .15s ease;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      white-space: nowrap;
    }

    .seg button.active {
      background: rgba(37, 99, 235, .12);
      color: var(--primary-2);
      font-weight: 700;
    }

    .help {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }

    .note {
      margin-top: 10px;
      border: 1px dashed rgba(148, 163, 184, .45);
      background: rgba(148, 163, 184, .08);
      border-radius: 14px;
      padding: 10px 12px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.55;
    }

    .note code {
      font-family: var(--mono);
      font-size: 11px;
    }

    /* 搜索框 */
    .search {
      position: relative;
      flex: 1;
      min-width: 220px;
    }

    .search input {
      padding-left: 36px;
      font-size: 13px;
    }

    .search .icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      font-size: 14px;
      user-select: none;
      pointer-events: none;
    }

    /* 模板列表 */
    .tpl-tools {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
      min-width: 0;
    }

    .tpl-list {
      margin-top: 12px;
      border-top: 1px solid var(--line);
      padding-top: 10px;
      max-height: 360px;
      overflow: auto;
    }

    .tpl-item {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      padding: 10px 10px;
      border-radius: 14px;
      transition: background .15s ease;
    }

    .tpl-item:hover {
      background: rgba(15, 23, 42, .03);
    }

    :root[data-theme="dark"] .tpl-item:hover {
      background: rgba(255, 255, 255, .05);
    }

    .tpl-item input {
      margin-top: 4px;
    }

    .tpl-name {
      font-size: 13px;
      line-height: 1.35;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .tpl-meta {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      overflow-wrap: anywhere;
    }

    /* 字段区 */
    .badges {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(100, 116, 139, .08);
      color: var(--muted);
      font-size: 12px;
    }

    .badge b {
      color: var(--text);
    }

    details.group {
      border: 1px solid var(--line);
      border-radius: 16px;
      overflow: hidden;
      background: var(--card-strong);
      box-shadow: var(--shadow-soft);
      margin-bottom: 12px;

      /* ✅ 组定位也不被 footer 遮挡 */
      scroll-margin-bottom: calc(var(--footer-h) + 18px);
    }

    details.group summary {
      list-style: none;
      cursor: pointer;
      padding: 12px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(37, 99, 235, .09), transparent);
      user-select: none;
    }

    details.group summary::-webkit-details-marker {
      display: none;
    }

    .g-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      font-weight: 800;
      min-width: 0;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 99px;
      background: rgba(37, 99, 235, .55);
      box-shadow: 0 0 0 5px rgba(37, 99, 235, .10);
      flex: 0 0 auto;
    }

    .g-right {
      display: flex;
      gap: 10px;
      align-items: center;
      color: var(--muted);
      font-size: 12px;
      min-width: 0;
    }

    .g-right code {
      font-family: var(--mono);
      font-size: 11px;
      opacity: .9;
      white-space: nowrap;
    }

    .field-grid {
      padding: 12px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 980px) {
      .field-grid {
        grid-template-columns: 1fr;
      }
    }

    .field {
      border: 1px solid rgba(148, 163, 184, .25);
      border-radius: 16px;
      padding: 12px;
      background: rgba(15, 23, 42, .02);
      position: relative;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;

      /* ✅ 单字段定位也不被 footer 遮挡 */
      scroll-margin-bottom: calc(var(--footer-h) + 18px);
    }

    :root[data-theme="dark"] .field {
      background: rgba(255, 255, 255, .03);
    }

    .field.is-missing {
      border-color: rgba(239, 68, 68, .55);
      box-shadow: 0 0 0 4px rgba(239, 68, 68, .10);
      background: rgba(239, 68, 68, .06);
    }

    .field .top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 8px;
    }

    .field .key {
      font-size: 13px;
      font-weight: 900;
      letter-spacing: .1px;
      line-height: 1.2;
    }

    .field .ph {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      overflow-wrap: anywhere;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .55);
      color: var(--muted);
      font-size: 11px;
      user-select: none;
      white-space: nowrap;
    }

    :root[data-theme="dark"] .tag {
      background: rgba(17, 24, 39, .55);
    }

    .tag.req {
      border-color: rgba(239, 68, 68, .28);
      color: var(--danger);
      background: rgba(239, 68, 68, .10);
    }

    .tag.filled {
      border-color: rgba(22, 163, 74, .22);
      color: var(--ok);
      background: rgba(22, 163, 74, .10);
    }

    .count {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      margin-top: 6px;
    }

    /* 右侧粘性 */
    .side {
      position: sticky;
      top: 16px;
    }

    @media (max-width: 980px) {
      .side {
        position: static;
      }
    }

    .kv {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px dashed rgba(148, 163, 184, .35);
      font-size: 13px;
      color: var(--muted);
    }

    .kv:last-child {
      border-bottom: none;
    }

    .kv b {
      color: var(--text);
    }

    .status {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(15, 23, 42, .02);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.55;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
    }

    :root[data-theme="dark"] .status {
      background: rgba(255, 255, 255, .03);
    }

    /* ✅ 底部固定条（高度会变化：两行/三行都OK） */
    .footerbar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, .82);
      backdrop-filter: blur(14px);
      border-top: 1px solid var(--line);
      padding: 10px 16px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      z-index: 999;
      box-shadow: 0 -18px 48px rgba(15, 23, 42, .10);
    }

    :root[data-theme="dark"] .footerbar {
      background: rgba(17, 24, 39, .78);
      box-shadow: 0 -18px 48px rgba(0, 0, 0, .35);
    }

    .footerbar .inner {
      max-width: 1260px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      min-width: 0;
    }

    .footerbar .left {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      color: var(--muted);
      font-size: 12px;
      min-width: 0;
      overflow-wrap: anywhere;
    }

    .footerbar .right {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn.big {
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 900;
      letter-spacing: .2px;
      white-space: nowrap;
    }

    /* Toast（适配安全区，避免被系统状态栏/刘海遮挡） */
    .toastbox {
      position: fixed;
      right: calc(16px + env(safe-area-inset-right));
      top: calc(16px + env(safe-area-inset-top));
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
      pointer-events: none;
      /* ✅ 不挡点击 */
    }

    .toast {
      pointer-events: auto;
      min-width: 260px;
      max-width: 380px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: var(--card-strong);
      box-shadow: var(--shadow-soft);
      color: var(--text);
      font-size: 12px;
      line-height: 1.45;
      overflow-wrap: anywhere;
    }

    .toast.info {
      border-color: rgba(37, 99, 235, .28);
    }

    .toast.ok {
      border-color: rgba(22, 163, 74, .28);
    }

    .toast.warn {
      border-color: rgba(245, 158, 11, .35);
    }

    .toast.bad {
      border-color: rgba(239, 68, 68, .35);
    }

    /* Modal（小屏不遮挡：可滚动） */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, .45);
      display: none;
      z-index: 1100;
      padding: 18px;
      padding-top: calc(18px + env(safe-area-inset-top));
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-card {
      width: min(860px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, .35);
      background: var(--card-strong);
      box-shadow: var(--shadow);
      overflow: hidden;

      /* ✅ 关键：最大高度 + 内部滚动，避免“文字超出屏幕看不到” */
      max-height: calc(100vh - 36px);
      display: flex;
      flex-direction: column;
    }

    .modal-hd {
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      background: linear-gradient(180deg, rgba(37, 99, 235, .10), transparent);
      flex: 0 0 auto;
    }

    .modal-hd b {
      font-size: 14px;
    }

    .modal-bd {
      padding: 14px 16px 16px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.65;
      overflow: auto;
      /* ✅ 内容多就滚动，不被遮挡 */
    }

    .modal-bd code {
      font-family: var(--mono);
      font-size: 12px;
    }

    .modal-bd ul {
      margin: 8px 0 0 18px;
    }

    /* ✅ 小屏优化：减少拥挤、避免挤压遮挡 */
    @media (max-width: 520px) {
      .topbar {
        padding: 12px;
      }

      .brand-title b {
        font-size: 14px;
      }

      .chip {
        display: none;
      }

      /* 信息chip在超小屏隐藏，避免挤出（不影响功能） */
      .search {
        min-width: 160px;
      }

      .btn.big {
        width: 100%;
        justify-content: center;
      }

      .footerbar .right {
        width: 100%;
      }

      .footerbar .left {
        width: 100%;
      }
    }

    /* ✅ 减少动画：更稳 */
    @media (prefers-reduced-motion: reduce) {
      * {
        transition: none !important;
        scroll-behavior: auto !important;
      }
    }
  </style>
</head>

<body>
  <div class="toastbox" id="toastbox"></div>

  <div class="modal" id="helpModal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-hd">
        <b>使用说明（页面内快速版）</b>
        <button class="btn" id="btnCloseHelp" type="button">关闭</button>
      </div>
      <div class="modal-bd" id="helpContent">
        <div>
          这套工具的字段来源是：<b>扫描 docx 模板中的 <code>{{...}}</code> 占位符</b>。<br />
          操作流程：
          <ul>
            <li>① 选择产品类型（对应 <code>templates/产品类型/</code> 文件夹）</li>
            <li>② 勾选要生成的模板（或选择“生成全部”）</li>
            <li>③ 填写字段（长文本可直接粘贴，支持换行）</li>
            <li>④ 点击“生成并下载（zip）”</li>
          </ul>
          后续维护：想新增字段，就在模板里新增 <code>{{新字段}}</code>，然后点“重新扫描”即可。
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- 顶部栏 -->
    <div class="topbar">
      <div class="brand">
        <div class="logo">F</div>
        <div class="brand-title">
          <b>基金产品材料自动生成</b>
          <span>表单填报 → docx 替换 → 打包下载（zip）</span>
        </div>
      </div>

      <div class="top-actions">
        <span class="chip">接口：<code>/api/schema</code></span>
        <span class="chip">输出：<code>zip 下载</code></span>
        <button class="btn" id="btnHelp" type="button">使用说明</button>
        <button class="btn" id="btnTheme" type="button">切换主题</button>
      </div>
    </div>

    <!-- 步骤条 -->
    <div class="stepper">
      <div class="step active" id="step1">
        <div class="num">1</div>
        <div class="meta">
          <b>选择产品类型</b>
          <span>对应 templates/ 的子文件夹</span>
        </div>
      </div>
      <div class="step" id="step2">
        <div class="num">2</div>
        <div class="meta">
          <b>选择要生成的模板</b>
          <span>支持搜索 / 全选 / 全不选</span>
        </div>
      </div>
      <div class="step" id="step3">
        <div class="num">3</div>
        <div class="meta">
          <b>填写产品要素</b>
          <span>支持必填校验 / 长文本统计</span>
        </div>
      </div>
      <div class="step" id="step4">
        <div class="num">4</div>
        <div class="meta">
          <b>生成并下载</b>
          <span>zip 内含多个 docx</span>
        </div>
      </div>
    </div>

    <!-- 主区域 -->
    <div class="grid">
      <div class="main">
        <!-- ① 选择产品类型 -->
        <div class="card" style="margin-bottom:16px;">
          <div class="card-hd">
            <div>
              <h2>① 选择产品类型</h2>
              <div class="sub">选择后自动扫描该类型模板中的 {{...}} 占位符生成表单</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap: wrap; align-items:center;">
              <span class="chip" id="saveState">未保存</span>
            </div>
          </div>

          <div class="card-bd">
            <div class="row">
              <div>
                <label>产品类型</label>
                <select id="productType"></select>
                <div class="note">
                  <b>目录规则：</b>产品类型 = <code>templates/</code> 下的子文件夹名称。<br />
                  示例：选择“行业主题ETF” → 读取 <code>templates/行业主题ETF/</code> 中全部 docx。
                </div>
              </div>

              <div>
                <label>生成模式</label>
                <div class="seg" aria-label="生成模式">
                  <button id="modeAll" class="active" type="button">生成全部模板</button>
                  <button id="modeSelected" type="button">只生成勾选模板</button>
                </div>

                <label style="margin-top:12px;">未填写字段处理</label>
                <label style="margin:0; display:flex; gap:10px; align-items:center; color:var(--muted);">
                  <input id="blankUnfilled" type="checkbox" checked />
                  未填字段替换为空（避免文档残留 {{占位符}}）
                </label>

                <div class="note">
                  长文本可以直接粘贴（支持换行）。生成时尽量保持模板原格式（缩进/行距等）。
                </div>

                <label style="margin-top:12px;">生成文件夹命名（可选）</label>
                <input id="outputFolder" type="text" placeholder="留空则自动：产品类型_指数名称_YYYYMMDD_HHMMSS" />

                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                  <button class="btn" id="btnSuggestFolder" type="button">一键使用推荐命名</button>
                  <button class="btn" id="btnClearFolder" type="button">清空</button>
                </div>

                <div class="help">
                  该名称会用于：<code>output/子文件夹</code>、zip 文件名、以及 zip 内顶层文件夹名。<br />
                  Windows 不允许的字符（如 <code>\ / : * ? " &lt; &gt; |</code>）后端会自动替换为下划线。
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ② 选择模板 -->
        <div class="card" style="margin-bottom:16px;">
          <div class="card-hd">
            <div>
              <h2>② 选择要生成的模板</h2>
              <div class="sub">模板总数：<b id="tplCount">0</b>，已勾选：<b id="tplSelectedCount">0</b></div>
            </div>
            <div class="tpl-tools">
              <div class="search">
                <span class="icon">⌕</span>
                <input id="tplSearch" type="text" placeholder="搜索模板文件名（例如：承诺函 / 请示 / 风险评估）" />
              </div>
              <button class="btn" id="btnTplAll" type="button">全选</button>
              <button class="btn" id="btnTplNone" type="button">全不选</button>
            </div>
          </div>
          <div class="card-bd">
            <div class="tpl-list" id="templatesBox"></div>
            <div class="help">提示：切换为“只生成勾选模板”模式时，才按勾选结果生成。</div>
          </div>
        </div>

        <!-- ③ 填写要素 -->
        <div class="card">
          <div class="card-hd">
            <div>
              <h2>③ 填写产品要素</h2>
              <div class="sub">字段总数：<b id="fieldCount">0</b>，已填写：<b id="filledCount">0</b></div>
            </div>
            <div class="tpl-tools">
              <div class="search" style="max-width: 380px;">
                <span class="icon">⌕</span>
                <input id="fieldSearch" type="text" placeholder="搜索字段（例如：指数 / 费率 / 联系人 / 托管人）" />
              </div>
              <button class="btn" id="btnExpandAll" type="button">展开全部</button>
              <button class="btn" id="btnCollapseAll" type="button">折叠全部</button>
            </div>
          </div>

          <div class="card-bd">
            <div class="badges">
              <span class="badge">必填缺失：<b id="missingCount">0</b></span>
              <span class="badge">提示：框内灰字为“注释/示例”（placeholder）</span>
            </div>

            <div id="fields"></div>
          </div>
        </div>
      </div>

      <!-- 右侧概览与工具 -->
      <div class="side">
        <div class="card">
          <div class="card-hd">
            <div>
              <h2>概览与工具</h2>
              <div class="sub">自动保存 / 导入导出 / 重新扫描</div>
            </div>
          </div>
          <div class="card-bd">
            <div class="kv"><span>当前产品类型</span><b id="sumType">-</b></div>
            <div class="kv"><span>模板总数</span><b id="sumTplTotal">0</b></div>
            <div class="kv"><span>模板已选</span><b id="sumTplPick">0</b></div>
            <div class="kv"><span>字段总数</span><b id="sumFieldTotal">0</b></div>
            <div class="kv"><span>字段已填</span><b id="sumFieldFilled">0</b></div>

            <div style="display:flex; gap:10px; flex-wrap: wrap; margin-top:12px;">
              <button class="btn" id="btnReloadSchema" type="button">重新扫描模板</button>
              <button class="btn danger" id="btnClear" type="button">清空本页填写</button>
              <button class="btn" id="btnExport" type="button">导出 JSON</button>
              <label class="btn" style="cursor:pointer;">
                导入 JSON
                <input id="importFile" type="file" accept="application/json" style="display:none;">
              </label>
            </div>

            <div class="status" id="status">状态：初始化中…</div>

            <div class="note" style="margin-top: 12px;">
              <b>你后续最常改的地方：</b><br />
              1）框内注释 / 必填 / 强制下拉：改本页 JS 的 <code>FIELD_META</code><br />
              2）默认必填字段：改 <code>REQUIRED_FIELDS</code><br />
              3）字段分组规则：改 <code>groupNameForKey()</code>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 底部固定操作条 -->
  <div class="footerbar" id="footerbar">
    <div class="inner">
      <div class="left">
        <span>生成文件会自动下载 zip（Vercel 环境不会长期落盘）</span>
      </div>
      <div class="right">
        <button class="btn danger big" id="btnValidate" type="button">检查必填</button>
        <button class="btn primary big" id="generateBtn" type="button">生成并下载（zip）</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    /* =========================
       ✅ 关键修复：动态计算底部固定条高度，避免遮挡任何文字/输入框
       ========================= */
    function updateFooterHeightVar() {
      const fb = document.getElementById("footerbar");
      if (!fb) return;
      const h = fb.offsetHeight || 88;
      document.documentElement.style.setProperty("--footer-h", h + "px");
    }
    window.addEventListener("resize", updateFooterHeightVar);
    window.addEventListener("load", updateFooterHeightVar);

    /* =========================
       ✅ 你后续维护主要改这里（无需动后端）
       ========================= */

    // 1) 默认必填字段：缺失会提示并高亮
    const REQUIRED_FIELDS = ["指数名称", "文号年份"];

    // 2) 字段配置（框内注释、帮助说明、强制类型/下拉选项、分组、是否必填）
    //    key 必须与模板占位符 {{key}} 一致
    //    type 可选：text / textarea / select（不写则沿用后端 schema 推断）
    //    options：仅当 type=select 时生效
    const FIELD_META = {
      // ✅ 指数公司：下拉 + 自动带出（短字段/长字段都支持）
      "指数公司名称": {
        type: "select",
        options: [], // 由 manifest 自动注入
        placeholder: "请选择指数公司（自动带出简介/编制方案/资质等）",
        help: "选择后会自动带出：指数公司简称/官网/介绍/编制方案/资质（仍可手动修改）。"
      },
      "指数公司简称": {
        placeholder: "选择指数公司后自动带出，可编辑"
      },
      "指数公司官网": {
        placeholder: "选择指数公司后自动带出，可编辑（如 https://xxx）"
      },
      "指数公司介绍": {
        type: "textarea",
        placeholder: "选择指数公司后自动带出，可编辑（保留换行）"
      },
      "指数公司编制方案": {
        type: "textarea",
        placeholder: "选择指数公司后自动带出，可编辑（保留换行）"
      },
      "指数公司资质": {
        type: "textarea",
        placeholder: "选择指数公司后自动带出，可编辑（保留换行）"
      },
      "指数名称": { placeholder: "例如：电网设备 / 科创创业50", help: "用于替换 {{指数名称}}；如果文件名含 {{指数名称}}，也会同步替换。", required: true },
      "文号年份": { placeholder: "例如：2026（只填年份）", required: true },
      "托管人名称": { placeholder: "例如：招商银行股份有限公司" },
      "管理费率": { placeholder: "例如：0.50（不要带%号）" },
      "托管费率": { placeholder: "例如：0.10（不要带%号）" },
      "开放时间": { placeholder: "例如：上海证券交易所" },
      "指数简介": { placeholder: "一句话/一段话描述指数（可换行）", type: "textarea" },
      "数据截止日期": { placeholder: "例如：2025年12月31日", type: "textarea" },
      "托管人性质": { placeholder: "例如：商业银行、证券公司", type: "textarea" },
      "数据起始日期": { placeholder: "例如：2025年12月31日", type: "textarea" },
      "被动产品数量": { placeholder: "仅填写数字", type: "textarea" },
      "分红评估周期": { placeholder: "季度、月", type: "textarea" },
      "最小申赎单位": { placeholder: "仅填写数字", type: "textarea" },
      "成分股数量": { placeholder: "仅填写数字", type: "textarea" },
      "基金经理人数": { placeholder: "仅填写数字", type: "textarea" },

      // 示例：你想不改后端也做下拉，可以直接这样配置
      "基金类型": {
        type: "select",
        options: ["股票型基金", "混合型基金", "债券型基金", "货币市场基金", "FOF", "QDII", "REITs", "其他"],
        placeholder: "请选择基金类型"
      }
    };

    // 3) 置顶字段（更常填的排前面）
    const PIN_FIELDS = ["指数名称", "文号年份", "托管人名称", "上市交易所", "ETF类型", "指数公司"];

    // =========================
    // 页面状态
    // =========================
    let currentSchema = null;
    let currentMode = "all"; // all / selected
    let groupIndex = {};     // groupName -> { keys:[], detailsEl, countEl }

    // 本地缓存
    const STORAGE_PREFIX = "fund_docgen_v2:";
    const STORAGE_LAST_TYPE = STORAGE_PREFIX + "last_product_type";

    function toast(msg, type = "info") {
      const box = $("toastbox");
      const el = document.createElement("div");
      el.className = "toast " + (type || "info");
      el.textContent = msg;
      box.appendChild(el);
      setTimeout(() => { el.style.opacity = "0.0"; el.style.transform = "translateY(-4px)"; }, 2400);
      setTimeout(() => { el.remove(); }, 2900);
    }
    /* =========================
   ✅ 指数公司预设库（manifest + txt）
   文件位置：
   - /static/presets/index_company_manifest.json
   - /static/presets/index_company/*.txt
   ========================= */

    const STATIC_BASE = "/static";
    const INDEX_COMPANY_MANIFEST_URL = STATIC_BASE + "/presets/index_company_manifest.json";

    let INDEX_COMPANY_MANIFEST = null;
    const TEXT_CACHE = new Map();

    function isTxtPath(v) {
      return typeof v === "string" && v.trim().toLowerCase().endsWith(".txt");
    }

    async function fetchTextCached(url) {
      const u = encodeURI(url);
      if (TEXT_CACHE.has(u)) return TEXT_CACHE.get(u);
      const res = await fetch(u, { method: "GET" });
      if (!res.ok) throw new Error("读取失败：" + u);
      const txt = await res.text();
      TEXT_CACHE.set(u, txt);
      return txt;
    }

    // 读取 manifest，并把“指数公司名称”的下拉 options 注入 FIELD_META
    async function loadIndexCompanyManifest() {
      try {
        const res = await fetch(INDEX_COMPANY_MANIFEST_URL + "?_=" + Date.now(), { method: "GET" });
        if (!res.ok) {
          INDEX_COMPANY_MANIFEST = null;
          toast("未发现指数公司预设库（可选功能未启用）", "warn");
          return;
        }
        INDEX_COMPANY_MANIFEST = await res.json();

        // 把下拉选项设置为公司名称列表
        const companies = Object.keys(INDEX_COMPANY_MANIFEST || {}).sort();
        FIELD_META["指数公司名称"] = FIELD_META["指数公司名称"] || {};
        FIELD_META["指数公司名称"].type = "select";
        FIELD_META["指数公司名称"].options = companies;

        // 强制长文本字段为 textarea（避免被渲染成 input）
        ["指数公司介绍", "指数公司编制方案", "指数公司资质"].forEach(k => {
          FIELD_META[k] = FIELD_META[k] || {};
          FIELD_META[k].type = "textarea";
        });

        toast("指数公司库已加载：" + companies.length + " 家", "ok");
      } catch (e) {
        INDEX_COMPANY_MANIFEST = null;
        toast("指数公司库加载失败：" + (e.message || e), "warn");
      }
    }

    // 选择公司后：把 manifest（短字段）+ txt（长字段）写入表单
    async function applyIndexCompanyPreset(companyName) {
      if (!INDEX_COMPANY_MANIFEST) return;
      const mapping = INDEX_COMPANY_MANIFEST[companyName];
      if (!mapping) return;

      // 要写入的字段（你 manifest 里有哪些字段就写哪些）
      const targets = Object.keys(mapping);

      // 如果用户手动改过（且不是系统自动带出），切换时提示确认，避免误覆盖
      let manualTouched = false;
      for (const fieldKey of targets) {
        if (fieldKey === "指数公司名称") continue; // 选择框本身不算“手动改过”
        const el = document.getElementById(safeId(fieldKey));
        if (!el) continue;

        const cur = String(el.value || "").trim();
        const auto = (el.dataset && el.dataset.autofill === "index_company");
        if (cur && !auto) {
          manualTouched = true;
          break;
        }
      }

      if (manualTouched) {
        const ok = window.confirm(
          "检测到你已手动修改“指数公司”相关内容。\n" +
          "继续切换将覆盖这些修改，是否继续？"
        );
        if (!ok) return;
      }

      let changed = 0;

      for (const fieldKey of targets) {
        const el = document.getElementById(safeId(fieldKey));
        if (!el) continue;

        const v = mapping[fieldKey];

        // v 是 txt 路径 → 读取 txt；否则直接当作短字段文字
        let finalText = "";
        if (isTxtPath(v)) {
          const url = v.startsWith("http") ? v : (STATIC_BASE + "/" + v.replace(/^\/+/, ""));
          finalText = await fetchTextCached(url);
        } else {
          finalText = String(v ?? "");
        }

        el.value = finalText;

        // 标记为系统自动带出：下次切换不会把它当“手动修改”
        el.dataset.autofill = "index_company";
        el.dataset.autofillBy = companyName;

        changed += 1;
      }

      refreshFilledCountAndMissing();
      if (typeof updateGroupCounters === "function") updateGroupCounters();

      const productType = $("productType").value || "__root__";
      debounceSave(productType);

      toast(`已匹配“${companyName}”（${changed}项）`, "ok");
    }

    function bindIndexCompanyAutoFill(productType) {
      if (!INDEX_COMPANY_MANIFEST) return;

      const nameEl = document.getElementById(safeId("指数公司名称"));
      if (!nameEl) return;

      // 防重复绑定（因为每次重新扫描会重建 DOM）
      if (nameEl.__boundIndexCompany) return;
      nameEl.__boundIndexCompany = true;

      // 用户一旦手动编辑这些字段，就清除 autofill 标记（避免后续误覆盖）
      ["指数公司简称", "指数公司官网", "指数公司介绍", "指数公司编制方案", "指数公司资质"].forEach(fieldKey => {
        const el = document.getElementById(safeId(fieldKey));
        if (!el || el.__boundManualFlag) return;
        el.__boundManualFlag = true;

        el.addEventListener("input", () => {
          if (el.dataset && el.dataset.autofill) {
            delete el.dataset.autofill;
            delete el.dataset.autofillBy;
          }
        });
      });

      nameEl.addEventListener("change", async () => {
        const v = String(nameEl.value || "").trim();
        if (!v) return;
        try {
          await applyIndexCompanyPreset(v);
        } catch (e) {
          toast("自动匹配失败：" + (e.message || e), "bad");
        }
      });
    }


    function setStatus(msg) { $("status").textContent = msg || ""; }

    function setStep(n) {
      ["step1", "step2", "step3", "step4"].forEach((id, idx) => {
        $(id).classList.toggle("active", idx === (n - 1));
      });
    }

    function setMode(mode) {
      currentMode = mode;
      $("modeAll").classList.toggle("active", mode === "all");
      $("modeSelected").classList.toggle("active", mode === "selected");
      setStep(2);
      toast(mode === "all" ? "已切换：生成全部模板" : "已切换：只生成勾选模板", "info");
      refreshSummary();
      updateFooterHeightVar(); // ✅ footer 可能换行，更新高度
    }

    function safeId(key) {
      // 将中文 key 编码为安全 id
      const b64 = btoa(unescape(encodeURIComponent(key))).replace(/=+/g, '').replace(/[+/]/g, '_');
      return "f_" + b64;
    }

    function getCacheKey(productType) {
      return STORAGE_PREFIX + "values:" + (productType || "__root__");
    }

    function loadCachedValues(productType) {
      try {
        const raw = localStorage.getItem(getCacheKey(productType));
        return raw ? JSON.parse(raw) : {};
      } catch (e) {
        return {};
      }
    }

    function saveCachedValues(productType, values) {
      try {
        localStorage.setItem(getCacheKey(productType), JSON.stringify(values || {}));
        $("saveState").innerHTML = "已保存";
      } catch (e) {
        // ignore
      }
    }

    let saveTimer = null;
    function debounceSave(productType) {
      $("saveState").innerHTML = "未保存";
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        saveCachedValues(productType, collectValues());
      }, 450);
    }

    function isRequired(key) {
      if (FIELD_META[key]?.required) return true;
      return REQUIRED_FIELDS.includes(key);
    }

    function effectiveFieldDef(f) {
      const meta = FIELD_META[f.key] || {};
      const type = meta.type || f.type || "text";
      const options = meta.options || f.options || [];
      return { ...f, type, options, meta };
    }

    function applyPlaceholder(el, key) {
      const meta = FIELD_META[key] || {};
      el.placeholder = meta.placeholder || `用于替换 {{${key}}}`;
    }

    function groupNameForKey(key) {
      if ((FIELD_META[key] || {}).group) return FIELD_META[key].group;

      if (/指数|成分股|权重|样本|选样|基日|基点|编制|指数公司|发布日期|代码/.test(key)) return "指数要素";
      if (/费|费率|管理费|托管费|认购|申购|赎回/.test(key)) return "费率要素";
      if (/基金经理|督察长|合规|签字|高级管理人员|人数|产品数量/.test(key)) return "投资人员";
      if (/联系人|电话|手机|地址|邮箱/.test(key)) return "联系人信息";
      if (/托管人|登记|交易所|开放时间|最小申赎|分红/.test(key)) return "产品要素";
      if (/风险|揭示|评估|流动性/.test(key)) return "风险与合规材料";
      if (/投资|策略|价值|背景|可行性|说明|介绍/.test(key)) return "投资分析与说明";
      return "其他要素";
    }

    function listTplChecks() {
      return Array.from(document.querySelectorAll(".tpl-check"));
    }

    function getSelectedTemplates() {
      return listTplChecks().filter(ch => ch.checked).map(ch => ch.value);
    }

    function updateTplSelectedCount() {
      $("tplSelectedCount").textContent = String(getSelectedTemplates().length);
      refreshSummary();
      updateFooterHeightVar(); // ✅ 可能引发底部换行
    }

    function filterTemplates() {
      const q = ($("tplSearch").value || "").trim().toLowerCase();
      document.querySelectorAll(".tpl-item").forEach(item => {
        const name = (item.getAttribute("data-name") || "").toLowerCase();
        item.style.display = (!q || name.includes(q)) ? "" : "none";
      });
    }

    function filterFields() {
      const q = ($("fieldSearch").value || "").trim().toLowerCase();
      document.querySelectorAll(".field").forEach(card => {
        const key = (card.getAttribute("data-key") || "").toLowerCase();
        card.style.display = (!q || key.includes(q)) ? "" : "none";
      });
    }

    function refreshSummary() {
      const typeText = $("productType").selectedOptions?.[0]?.textContent || "-";
      $("sumType").textContent = typeText;
      $("sumTplTotal").textContent = String((currentSchema?.templates || []).length);
      $("sumTplPick").textContent = String(getSelectedTemplates().length);
      $("sumFieldTotal").textContent = String((currentSchema?.fields || []).length);
      $("sumFieldFilled").textContent = $("filledCount").textContent || "0";
    }

    function collectValues() {
      const values = {};
      (currentSchema?.fields || []).forEach(f => {
        const key = f.key;
        const el = document.getElementById(safeId(key));
        values[key] = el ? el.value : "";
      });
      return values;
    }

    function fillValues(values) {
      values = values || {};
      (currentSchema?.fields || []).forEach(f => {
        const key = f.key;
        const el = document.getElementById(safeId(key));
        if (el && Object.prototype.hasOwnProperty.call(values, key)) {
          el.value = values[key] ?? "";
        }
      });
      refreshFilledCountAndMissing();
    }

    function refreshFilledCountAndMissing() {
      if (!currentSchema) return;

      let filled = 0;
      let missingReq = 0;

      document.querySelectorAll(".field").forEach(el => el.classList.remove("is-missing"));

      (currentSchema.fields || []).forEach(f => {
        const key = f.key;
        const el = document.getElementById(safeId(key));
        const v = String(el?.value || "").trim();

        const card = document.getElementById(safeId(key) + "__card");
        const filledTag = document.getElementById(safeId(key) + "__filled");
        if (filledTag) {
          filledTag.style.display = v ? "" : "none";
        }

        if (v) filled += 1;

        if (isRequired(key) && !v) {
          missingReq += 1;
          if (card) card.classList.add("is-missing");
        }

        const counter = document.getElementById(safeId(key) + "__count");
        if (counter && el && el.tagName.toLowerCase() === "textarea") {
          counter.textContent = String((el.value || "").length) + " chars";
          counter.style.display = "";
        }
      });

      $("filledCount").textContent = String(filled);
      $("missingCount").textContent = String(missingReq);

      refreshSummary();
    }

    function renderTemplates(templates) {
      $("tplCount").textContent = String(templates?.length || 0);

      const box = $("templatesBox");
      box.innerHTML = "";

      if (!templates || templates.length === 0) {
        box.innerHTML = "<div style='color:var(--muted); font-size:13px;'>该产品类型目录下没有 docx 模板</div>";
        updateTplSelectedCount();
        return;
      }

      templates.forEach(fn => {
        const item = document.createElement("div");
        item.className = "tpl-item";
        item.setAttribute("data-name", fn);

        item.innerHTML = `
          <input class="tpl-check" type="checkbox" value="${fn}" checked/>
          <div style="flex:1; min-width:0;">
            <div class="tpl-name">${fn}</div>
            <div class="tpl-meta">文件名中若有 {{占位符}}，生成时也会自动替换</div>
          </div>
        `;
        box.appendChild(item);
      });

      listTplChecks().forEach(ch => ch.addEventListener("change", updateTplSelectedCount));

      updateTplSelectedCount();
      filterTemplates();
      setStep(2);
    }

    function renderFields(fields, productType) {
      $("fieldCount").textContent = String(fields?.length || 0);

      const root = $("fields");
      root.innerHTML = "";
      groupIndex = {};

      if (!fields || fields.length === 0) {
        root.innerHTML = "<div style='color:var(--muted); font-size:13px;'>未扫描到 {{占位符}}。请检查模板是否包含 {{...}}。</div>";
        refreshFilledCountAndMissing();
        return;
      }

      const pinned = [];
      const others = [];
      fields.forEach(f => (PIN_FIELDS.includes(f.key) ? pinned : others).push(f));
      const sorted = [...pinned, ...others];

      const groups = {};
      sorted.forEach(f => {
        const g = groupNameForKey(f.key);
        if (!groups[g]) groups[g] = [];
        groups[g].push(f);
      });

      const names = Object.keys(groups);
      names.forEach((gname, idx) => {
        const det = document.createElement("details");
        det.className = "group";
        det.open = idx < 2;

        const countId = safeId(gname) + "__gcount";
        const summary = document.createElement("summary");
        summary.innerHTML = `
          <div class="g-title"><span class="dot"></span>${gname}</div>
          <div class="g-right"><span id="${countId}">0/${groups[gname].length}</span><code>点击折叠/展开</code></div>
        `;
        det.appendChild(summary);

        const grid = document.createElement("div");
        grid.className = "field-grid";

        groupIndex[gname] = { keys: [], detailsEl: det, countElId: countId };

        groups[gname].forEach(raw => {
          const f = effectiveFieldDef(raw);
          const key = f.key;
          const meta = f.meta || {};
          const id = safeId(key);

          groupIndex[gname].keys.push(key);

          const card = document.createElement("div");
          card.className = "field";
          card.id = id + "__card";
          card.setAttribute("data-key", key);

          const req = isRequired(key);
          const reqTag = req ? `<span class="tag req">必填</span>` : "";

          card.innerHTML = `
            <div class="top">
              <div style="min-width:0;">
                <div class="key">${key}</div>
                <div class="ph">{{${key}}}</div>
              </div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap: wrap;">
                ${reqTag}
                <span class="tag filled" id="${id}__filled" style="display:none;">已填</span>
              </div>
            </div>
          `;

          let el;
          if (f.type === "textarea") {
            el = document.createElement("textarea");
          } else if (f.type === "select") {
            el = document.createElement("select");
            const empty = document.createElement("option");
            empty.value = "";
            empty.textContent = "（请选择）";
            el.appendChild(empty);
            (f.options || []).forEach(v => {
              const opt = document.createElement("option");
              opt.value = v;
              opt.textContent = v;
              el.appendChild(opt);
            });
          } else {
            el = document.createElement("input");
            el.type = "text";
          }

          el.id = id;
          applyPlaceholder(el, key);

          const onChange = () => {
            refreshFilledCountAndMissing();
            debounceSave(productType);
            setStep(3);
          };
          el.addEventListener("input", onChange);
          el.addEventListener("change", onChange);

          card.appendChild(el);

          if (meta.help) {
            const h = document.createElement("div");
            h.className = "help";
            h.textContent = meta.help;
            card.appendChild(h);
          }

          if (f.type === "textarea") {
            const c = document.createElement("div");
            c.className = "count";
            c.id = id + "__count";
            c.textContent = "0 chars";
            card.appendChild(c);
          }

          grid.appendChild(card);
        });

        det.appendChild(grid);
        root.appendChild(det);
      });

      refreshFilledCountAndMissing();
      filterFields();
      setStep(3);

      // 字段渲染后，footer 高度也可能变化（尤其小屏），更新一下
      updateFooterHeightVar();
    }

    function updateGroupCounters() {
      Object.keys(groupIndex).forEach(gname => {
        const info = groupIndex[gname];
        const total = info.keys.length;
        let filled = 0;
        info.keys.forEach(key => {
          const el = document.getElementById(safeId(key));
          if (el && String(el.value || "").trim() !== "") filled += 1;
        });
        const c = document.getElementById(info.countElId);
        if (c) c.textContent = `${filled}/${total}`;
      });
    }

    function validateRequired({ scrollToFirst = true } = {}) {
      if (!currentSchema) return { ok: true, missing: [] };

      const missing = [];
      (currentSchema.fields || []).forEach(f => {
        const key = f.key;
        if (!isRequired(key)) return;
        const el = document.getElementById(safeId(key));
        if (!el || String(el.value || "").trim() === "") {
          missing.push(key);
        }
      });

      refreshFilledCountAndMissing();
      updateGroupCounters();

      if (missing.length) {
        toast(`必填缺失：${missing.length} 项`, "bad");

        if (scrollToFirst) {
          const firstKey = missing[0];
          const card = document.getElementById(safeId(firstKey) + "__card");
          if (card) {
            Object.keys(groupIndex).forEach(gname => {
              if (groupIndex[gname].keys.includes(firstKey)) {
                groupIndex[gname].detailsEl.open = true;
              }
            });
            card.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        }
        return { ok: false, missing };
      }
      toast("必填检查通过 ✅", "ok");
      return { ok: true, missing: [] };
    }

    // API（fetch）
    async function apiGet(url) {
      const res = await fetch(url, { method: "GET" });
      const json = await res.json();
      return json;
    }

    async function apiPost(url, body) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      });
      const json = await res.json();
      return json;
    }

    async function loadProductTypes() {
      setStatus("正在读取产品类型…");
      const resp = await apiGet("/api/product_types");
      if (!resp.ok) throw new Error(resp.error || "读取产品类型失败");

      const types = resp.data || [];
      const sel = $("productType");
      sel.innerHTML = "";

      if (types.length === 0) {
        const opt = document.createElement("option");
        opt.value = "__root__";
        opt.textContent = "未发现模板（请先放入 templates/）";
        sel.appendChild(opt);
        return;
      }

      types.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        sel.appendChild(opt);
      });

      const last = localStorage.getItem(STORAGE_LAST_TYPE);
      if (last) {
        const found = Array.from(sel.options).some(o => o.value === last);
        if (found) sel.value = last;
      }
    }

    async function loadSchema({ useCache = true } = {}) {
      const productType = $("productType").value || "__root__";
      localStorage.setItem(STORAGE_LAST_TYPE, productType);

      setStatus("正在扫描模板占位符（{{...}}）…首次可能稍慢");
      const resp = await apiGet("/api/schema?product_type=" + encodeURIComponent(productType));
      if (!resp.ok) throw new Error(resp.error || "读取 schema 失败");

      currentSchema = resp.data;
      renderTemplates(currentSchema.templates || []);
      renderFields(currentSchema.fields || [], productType);

      if (useCache) {
        fillValues(loadCachedValues(productType));
        $("saveState").innerHTML = "已保存";
      } else {
        $("saveState").innerHTML = "未保存";
      }
      // ✅ 新增：字段渲染完成后绑定指数公司自动填充
      bindIndexCompanyAutoFill(productType);


      updateGroupCounters();
      refreshSummary();
      setStatus("就绪：填写要素后点击右下角“生成并下载”。");
      toast("已加载模板与字段 ✅", "ok");
      setStep(1);

      updateFooterHeightVar();
    }

        async function generate() {
      if (!currentSchema) return;

      const productType = $("productType").value || "__root__";

      const v = validateRequired({ scrollToFirst: true });
      if (!v.ok) {
        setStatus("请先补全必填项后再生成。缺失字段：\n- " + v.missing.join("\n- "));
        return;
      }

      const selected = getSelectedTemplates();
      if (currentMode === "selected" && selected.length === 0) {
        toast("当前为“只生成勾选模板”，请至少勾选一个模板。", "warn");
        setStatus("请勾选至少一个模板。");
        return;
      }

      const payload = {
        product_type: productType,
        mode: currentMode,
        blank_unfilled: $("blankUnfilled").checked,
        selected_templates: currentMode === "selected" ? selected : [],
        output_folder: ($("outputFolder")?.value || "").trim(),
        values: collectValues()
      };

      $("generateBtn").disabled = true;
      setStep(4);
      setStatus("正在生成中…");

      try {
        const res = await fetch("/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload || {})
        });

        const ct = (res.headers.get("content-type") || "").toLowerCase();

        if (!res.ok) {
          // 后端失败时通常返回 JSON：{ ok:false, error:"..." }
          if (ct.includes("application/json")) {
            const j = await res.json();
            throw new Error(j?.error || "生成失败");
          }
          const t = await res.text();
          throw new Error(t || "生成失败");
        }

        // 成功：后端直接返回 zip（二进制流）
        const blob = await res.blob();

        // 尝试从 Content-Disposition 取文件名
        let filename = "output.zip";
        const cd = res.headers.get("content-disposition") || "";
        const m = cd.match(/filename\*=UTF-8''([^;]+)|filename="?([^\";]+)"?/i);
        if (m) {
          filename = decodeURIComponent(m[1] || m[2] || filename);
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        setStatus(
          "生成成功 ✅\n" +
          "zip 文件：" + filename + "\n" +
          "（已触发浏览器下载）"
        );
        toast("生成成功，已开始下载 ✅", "ok");
      } catch (e) {
        setStatus("失败 ❌：" + (e.message || e));
        toast("生成失败：" + (e.message || e), "bad");
      } finally {
        $("generateBtn").disabled = false;
        updateFooterHeightVar();
      }
    }

    function clearCurrent() {
      if (!currentSchema) return;
      (currentSchema.fields || []).forEach(f => {
        const el = document.getElementById(safeId(f.key));
        if (el) el.value = "";
      });
      refreshFilledCountAndMissing();
      updateGroupCounters();

      const productType = $("productType").value || "__root__";
      saveCachedValues(productType, collectValues());
      setStatus("已清空，并已保存。");
      toast("已清空当前填写", "info");
    }

    function exportJSON() {
      const productType = $("productType").value || "__root__";
      const data = { product_type: productType, values: collectValues(), exported_at: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `填报数据_${productType}_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      URL.revokeObjectURL(url);
      toast("已导出 JSON ✅", "ok");
    }

    function importJSON(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const obj = JSON.parse(reader.result);
          fillValues(obj.values || obj);

          const productType = $("productType").value || "__root__";
          saveCachedValues(productType, collectValues());
          setStatus("已导入 JSON 并回填 ✅");
          toast("导入成功 ✅", "ok");
        } catch (e) {
          setStatus("导入失败：JSON 格式不正确");
          toast("导入失败：JSON 格式不正确", "bad");
        }
      };
      reader.readAsText(file, "utf-8");
    }

    function setTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem(STORAGE_PREFIX + "theme", theme);
      toast(theme === "dark" ? "已切换：深色主题" : "已切换：浅色主题", "info");
      updateFooterHeightVar();
    }

    function toggleTheme() {
      const cur = document.documentElement.getAttribute("data-theme") || "light";
      setTheme(cur === "dark" ? "light" : "dark");
    }

    function fmtNow() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      return (
        d.getFullYear() +
        pad(d.getMonth() + 1) +
        pad(d.getDate()) + "_" +
        pad(d.getHours()) +
        pad(d.getMinutes()) +
        pad(d.getSeconds())
      );
    }

    function suggestOutputFolderName() {
      const typeText = $("productType").selectedOptions?.[0]?.textContent || $("productType").value || "产品";
      const idxEl = document.getElementById(safeId("指数名称"));
      const yearEl = document.getElementById(safeId("文号年份"));
      const idx = (idxEl?.value || "").trim();
      const year = (yearEl?.value || "").trim();

      const parts = [typeText, idx || "未命名", year || "", fmtNow()].filter(Boolean);
      $("outputFolder").value = parts.join("_");
      toast("已填入推荐文件夹名", "ok");
    }


    // 事件绑定
    $("btnHelp").addEventListener("click", () => $("helpModal").classList.add("show"));
    $("btnCloseHelp").addEventListener("click", () => $("helpModal").classList.remove("show"));
    $("helpModal").addEventListener("click", (e) => { if (e.target === $("helpModal")) $("helpModal").classList.remove("show"); });

    $("btnTheme").addEventListener("click", toggleTheme);
    $("btnSuggestFolder").addEventListener("click", suggestOutputFolderName);
    $("btnClearFolder").addEventListener("click", () => { $("outputFolder").value = ""; toast("已清空文件夹命名", "info"); });


    $("modeAll").addEventListener("click", () => setMode("all"));
    $("modeSelected").addEventListener("click", () => setMode("selected"));

    $("tplSearch").addEventListener("input", filterTemplates);
    $("fieldSearch").addEventListener("input", filterFields);

    $("btnTplAll").addEventListener("click", () => {
      listTplChecks().forEach(ch => ch.checked = true);
      updateTplSelectedCount();
      toast("模板已全选", "info");
    });
    $("btnTplNone").addEventListener("click", () => {
      listTplChecks().forEach(ch => ch.checked = false);
      updateTplSelectedCount();
      toast("模板已全不选", "info");
    });

    $("btnExpandAll").addEventListener("click", () => {
      document.querySelectorAll("details.group").forEach(d => d.open = true);
      toast("已展开全部分组", "info");
      updateFooterHeightVar();
    });
    $("btnCollapseAll").addEventListener("click", () => {
      document.querySelectorAll("details.group").forEach(d => d.open = false);
      toast("已折叠全部分组", "info");
      updateFooterHeightVar();
    });

    $("btnReloadSchema").addEventListener("click", async () => {
      try {
        await loadSchema({ useCache: true });
        setStatus("已重新扫描模板占位符 ✅");
        toast("重新扫描完成 ✅", "ok");
      } catch (e) {
        setStatus("重新扫描失败：" + (e.message || e));
        toast("重新扫描失败：" + (e.message || e), "bad");
      }
    });

    $("btnValidate").addEventListener("click", () => {
      const r = validateRequired({ scrollToFirst: true });
      if (!r.ok) {
        setStatus("必填缺失：\n- " + r.missing.join("\n- "));
      }
    });

    $("generateBtn").addEventListener("click", generate);

    $("btnClear").addEventListener("click", clearCurrent);
    $("btnExport").addEventListener("click", exportJSON);
    $("importFile").addEventListener("change", (e) => importJSON(e.target.files?.[0]));

    $("productType").addEventListener("change", async () => {
      try {
        setStep(1);
        await loadSchema({ useCache: true });
      } catch (e) {
        setStatus("切换产品类型失败：" + (e.message || e));
        toast("切换失败：" + (e.message || e), "bad");
      }
    });

    // 初始化
    (async function init() {
      try {
        const theme = localStorage.getItem(STORAGE_PREFIX + "theme") || "light";
        document.documentElement.setAttribute("data-theme", theme);

        // ✅ 新增：先加载指数公司 manifest（失败也不影响其他功能）
        await loadIndexCompanyManifest();

        setMode("all");
        await loadProductTypes();
        await loadSchema({ useCache: true });

        $("saveState").innerHTML = "已保存";
        setStep(1);
      } catch (e) {
        setStatus("初始化失败：" + (e.message || e));
        toast("初始化失败：" + (e.message || e), "bad");
      }
    })();
  </script>
</body>

</html>